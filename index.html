// Funções de Planejamento
let selectedPeriodId = null;
let currentAthlete = null;
let athletesData = {};
let cycles = {};

function loadAthleteCycles() {
    if (!currentAthlete) return;
    
    const athleteId = Object.keys(athletesData).find(id => 
        athletesData[id].name === currentAthlete.name
    );
    
    const athleteCycles = cycles[athleteId] || [];
    loadPeriods(athleteCycles);
}

function loadPeriods(periods) {
    const tbody = document.getElementById('periodsTableBody');
    const noPeriodsMessage = document.getElementById('noPeriodsMessage');
    
    if (periods.length === 0) {
        tbody.innerHTML = '';
        noPeriodsMessage.style.display = 'block';
        document.getElementById('periodDetails').style.display = 'none';
        return;
    }
    
    noPeriodsMessage.style.display = 'none';
    
    tbody.innerHTML = periods.map((period, index) => {
        const startDate = new Date(period.startDate);
        const endDate = new Date(period.endDate);
        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24 * 7));
        const status = getPeriodStatus(period);
        
        return `
            <tr onclick="selectPeriod('${period.id}')" ${selectedPeriodId === period.id ? 'class="selected"' : ''}>
                <td>${period.number}</td>
                <td>${formatDate(startDate)}</td>
                <td>${formatDate(endDate)}</td>
                <td>${duration} semanas</td>
                <td><span class="period-status ${status.class}">${status.text}</span></td>
                <td>
                    <button class="action-btn edit" onclick="event.stopPropagation(); editPeriod('${period.id}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" onclick="event.stopPropagation(); deletePeriod('${period.id}')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // Selecionar primeiro período se nenhum estiver selecionado
    if (!selectedPeriodId && periods.length > 0) {
        selectPeriod(periods[0].id);
    }
}

function getPeriodStatus(period) {
    const now = new Date();
    const start = new Date(period.startDate);
    const end = new Date(period.endDate);
    
    if (now < start) {
        return { class: 'status-planned', text: 'Planejado' };
    } else if (now >= start && now <= end) {
        return { class: 'status-active', text: 'Ativo' };
    } else {
        return { class: 'status-completed', text: 'Concluído' };
    }
}

function selectPeriod(periodId) {
    selectedPeriodId = periodId;
    
    const athleteId = Object.keys(athletesData).find(id => 
        athletesData[id].name === currentAthlete.name
    );
    
    const period = cycles[athleteId]?.find(p => p.id === periodId);
    if (!period) return;
    
    // Atualizar seleção visual
    document.querySelectorAll('.periods-table tr').forEach(tr => tr.classList.remove('selected'));
    event?.target?.closest('tr')?.classList.add('selected');
    
    // Mostrar detalhes do período
    document.getElementById('periodDetails').style.display = 'block';
    document.getElementById('periodDetailsTitle').textContent = `Período ${period.number}`;
    
    const startDate = new Date(period.startDate);
    const endDate = new Date(period.endDate);
    const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24 * 7));
    
    document.getElementById('periodDuration').textContent = `${duration} semanas`;
    document.getElementById('periodDates').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
    document.getElementById('orientationContent').innerHTML = `<p>${period.orientation || 'Nenhuma orientação definida.'}</p>`;
    
    // Carregar microciclos
    loadMicrocycles(period);
}

function loadMicrocycles(period) {
    const tbody = document.getElementById('microcyclesTableBody');
    const startDate = new Date(period.startDate);
    const endDate = new Date(period.endDate);
    const totalWeeks = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24 * 7));
    
    let microcycles = [];
    for (let i = 0; i < totalWeeks; i++) {
        const microStart = new Date(startDate);
        microStart.setDate(microStart.getDate() + (i * 7));
        
        const microEnd = new Date(microStart);
        microEnd.setDate(microEnd.getDate() + 6);
        
        microcycles.push({
            number: i + 1,
            type: getMicrocycleType(i + 1, totalWeeks),
            startDate: microStart,
            endDate: microEnd,
            status: getMicrocycleStatus(microStart, microEnd)
        });
    }
    
    tbody.innerHTML = microcycles.map(micro => `
        <tr>
            <td><input type="checkbox" value="${micro.number}"></td>
            <td>${micro.number}</td>
            <td><span class="cycle-type-badge type-${micro.type.toLowerCase().replace(' ', '-')}">${micro.type}</span></td>
            <td>${formatDate(micro.startDate)}</td>
            <td>${formatDate(micro.endDate)}</td>
            <td><span class="micro-status ${micro.status.class}">${micro.status.text}</span></td>
            <td>
                <button class="action-btn edit" title="Editar microciclo">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn" title="Ver planilha">
                    <i class="fas fa-file-alt"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function getMicrocycleType(weekNumber, totalWeeks) {
    // Lógica simples para determinar tipos de microciclos
    if (weekNumber === 1) return 'Base Geral';
    if (weekNumber === totalWeeks) return 'Recuperação';
    if (weekNumber % 4 === 0) return 'Recuperação';
    if (weekNumber > totalWeeks - 4) return 'Específico';
    return 'Base Geral';
}

function getMicrocycleStatus(startDate, endDate) {
    const now = new Date();
    
    if (now < startDate) {
        return { class: 'status-planned', text: 'Liberado' };
    } else if (now >= startDate && now <= endDate) {
        return { class: 'status-active', text: 'Liberado' };
    } else {
        return { class: 'status-completed', text: 'Liberado' };
    }
}

function openCycleModal(cycleId = null) {
    if (cycleId) {
        // Modo edição
        document.getElementById('cycleModalTitle').textContent = 'Editar Macrociclo';
        document.getElementById('submitCycleBtn').textContent = 'Salvar Alterações';
        // Carregar dados do ciclo...
    } else {
        // Modo criação
        document.getElementById('cycleModalTitle').textContent = 'Novo Macrociclo';
        document.getElementById('submitCycleBtn').textContent = 'Criar Macrociclo';
        document.getElementById('cycleForm').reset();
    }
    
    document.getElementById('cycleModal').classList.add('active');
}

function closeCycleModal() {
    document.getElementById('cycleModal').classList.remove('active');
    document.getElementById('cycleForm').reset();
}

function calculateCycleEndDate() {
    const startDate = document.getElementById('cycleStartDate').value;
    const duration = parseInt(document.getElementById('cycleDuration').value);
    
    if (startDate && duration) {
        const start = new Date(startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + (duration * 7) - 1);
        
        document.getElementById('cycleEndDate').value = end.toISOString().split('T')[0];
    }
}

function handleCycleSubmit(e) {
    e.preventDefault();
    
    if (!currentAthlete) return;
    
    const athleteId = Object.keys(athletesData).find(id => 
        athletesData[id].name === currentAthlete.name
    );
    
    const cycleData = {
        id: Date.now().toString(),
        number: parseInt(document.getElementById('cycleNumber').value),
        startDate: document.getElementById('cycleStartDate').value,
        endDate: document.getElementById('cycleEndDate').value,
        duration: parseInt(document.getElementById('cycleDuration').value),
        orientation: document.getElementById('cycleOrientation').value
    };
    
    if (!cycles[athleteId]) {
        cycles[athleteId] = [];
    }
    
    cycles[athleteId].push(cycleData);
    cycles[athleteId].sort((a, b) => a.number - b.number);
    
    localStorage.setItem('cycles', JSON.stringify(cycles));
    
    closeCycleModal();
    loadAthleteCycles();
    alert('Macrociclo criado com sucesso!');
}

function editPeriod(periodId) {
    if (periodId) {
        openCycleModal(periodId);
    } else {
        // Editar período selecionado
        if (selectedPeriodId) {
            openCycleModal(selectedPeriodId);
        }
    }
}

function deletePeriod(periodId) {
    if (confirm('Tem certeza que deseja excluir este período? Todos os microciclos serão perdidos.')) {
        const athleteId = Object.keys(athletesData).find(id => 
            athletesData[id].name === currentAthlete.name
        );
        
        if (cycles[athleteId]) {
            cycles[athleteId] = cycles[athleteId].filter(cycle => cycle.id !== periodId);
            localStorage.setItem('cycles', JSON.stringify(cycles));
            
            if (selectedPeriodId === periodId) {
                selectedPeriodId = null;
                document.getElementById('periodDetails').style.display = 'none';
            }
            
            loadAthleteCycles();
            alert('Período excluído com sucesso!');
        }
    }
}

function editOrientation() {
    const newOrientation = prompt('Digite a nova orientação para este período:', 
        document.getElementById('orientationContent').textContent);
    
    if (newOrientation !== null) {
        document.getElementById('orientationContent').innerHTML = `<p>${newOrientation}</p>`;
        
        // Salvar no localStorage
        const athleteId = Object.keys(athletesData).find(id => 
            athletesData[id].name === currentAthlete.name
        );
        
        if (cycles[athleteId] && selectedPeriodId) {
            const period = cycles[athleteId].find(p => p.id === selectedPeriodId);
            if (period) {
                period.orientation = newOrientation;
                localStorage.setItem('cycles', JSON.stringify(cycles));
            }
        }
    }
}

function copyCycleFromAthlete() {
    const athleteNames = Object.values(athletesData).map(athlete => athlete.name);
    const currentAthleteName = currentAthlete.name;
    const otherAthletes = athleteNames.filter(name => name !== currentAthleteName);
    
    if (otherAthletes.length === 0) {
        alert('Não há outros atletas para copiar o planejamento.');
        return;
    }
    
    const selectedAthlete = prompt(`Copiar planejamento de qual atleta?\n\n${otherAthletes.map((name, index) => `${index + 1}. ${name}`).join('\n')}\n\nDigite o número:`);
    
    if (selectedAthlete && selectedAthlete > 0 && selectedAthlete <= otherAthletes.length) {
        const sourceAthleteName = otherAthletes[selectedAthlete - 1];
        const sourceAthleteId = Object.keys(athletesData).find(id => 
            athletesData[id].name === sourceAthleteName
        );
        
        const sourceCycles = cycles[sourceAthleteId];
        if (sourceCycles && sourceCycles.length > 0) {
            const currentAthleteId = Object.keys(athletesData).find(id => 
                athletesData[id].name === currentAthlete.name
            );
            
            // Copiar ciclos ajustando IDs
            const copiedCycles = sourceCycles.map(cycle => ({
                ...cycle,
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9)
            }));
            
            cycles[currentAthleteId] = copiedCycles;
            localStorage.setItem('cycles', JSON.stringify(cycles));
            
            loadAthleteCycles();
            alert(`Planejamento copiado de ${sourceAthleteName} com sucesso!`);
        } else {
            alert(`${sourceAthleteName} não possui planejamento para copiar.`);
        }
    }
}

// Inicialização quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', function() {
    // Inicialização de dados e eventos aqui
    // Carregar dados do localStorage, etc.
});

// Função auxiliar para formatação de data
function formatDate(date) {
    if (!date) return '';
    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    return date.toLocaleDateString('pt-BR', options);
}
